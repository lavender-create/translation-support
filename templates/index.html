<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ç¿»è¨³ã‚µãƒãƒ¼ãƒˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
  <main class="container">
    <header class="header">
      <h1>ç¿»è¨³ã‚µãƒãƒ¼ãƒˆ</h1>
      <p>ç¿»è¨³ â†’ è¦ç´„ â†’ æ„å›³è§£æï¼ˆè³ªå•ï¼ä¾é ¼ï¼é‡è¦åº¦ï¼å¯¾å¿œï¼‰ã‚’ã¾ã¨ã‚ã¦ç¢ºèªã§ãã¾ã™ã€‚</p>
    </header>

    <!-- åŸæ–‡å…¥åŠ› -->
    <section class="card">
      <form method="post">
        <label for="text">åŸæ–‡ï¼ˆæ—¥æœ¬èªãƒ»è‹±èªã©ã¡ã‚‰ã§ã‚‚ï¼‰</label>
        <textarea
          id="text"
          name="text"
          placeholder="ã“ã“ã«æ–‡ç« ã‚’å…¥åŠ›ã€ã¾ãŸã¯éŸ³å£°å…¥åŠ›ã—ã¦ãã ã•ã„"
        ></textarea>

        <div class="actions">
          <button type="submit" class="btn-translate">ç¿»è¨³</button>


          <!-- ğŸ¤ éŸ³å£°å…¥åŠ›ï¼šè¨€èªåˆ‡æ›¿ -->
          <button type="button" id="micJaBtn" onclick="startDictation('ja-JP')">ğŸ¤ æ—¥æœ¬èª</button>
          <button type="button" id="micEnBtn" onclick="startDictation('en-US')">ğŸ¤ English</button>
        </div>

        <div class="small">
          â€» APIã‚­ãƒ¼ã¯ .env ã«ä¿å­˜ã—ã€GitHubã«ã¯å«ã‚ã¾ã›ã‚“ã€‚<br>
          â€» éŸ³å£°å…¥åŠ›ã¯ Chrome / Edge æ¨å¥¨ã§ã™ã€‚
        </div>
      </form>
    </section>

    <!-- çµæœè¡¨ç¤º -->
    <section class="grid">
      <section class="card">
        <h2 class="section-title">å…¥åŠ›å†…å®¹</h2>
        <pre>{{ input_text }}</pre>
      </section>

      <section class="card">
        <h2 class="section-title">ç¿»è¨³çµæœ</h2>
        <pre>{{ translation }}</pre>
      </section>

      <section class="card">
        <h2 class="section-title">è¦ç´„</h2>
        <pre>{{ summary }}</pre>
      </section>

      <section class="card">
        <h2 class="section-title">æ„å›³è§£æ</h2>
        <pre>{{ intent }}</pre>
      </section>
    </section>
  </main>

  <script>
    // =========================
    // ğŸ¤ éŸ³å£°å…¥åŠ›ï¼ˆSpeechRecognitionï¼‰æ—¥è‹±åˆ‡æ›¿
    // =========================
    function startDictation(lang) {
      const SpeechRecognition =
        window.SpeechRecognition || window.webkitSpeechRecognition;

      if (!SpeechRecognition) {
        alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°å…¥åŠ›ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚Chrome / Edge ã‚’ãŠä½¿ã„ãã ã•ã„ã€‚");
        return;
      }

      const recognition = new SpeechRecognition();
      recognition.lang = lang;          // â˜…ã“ã“ã§è¨€èªã‚’åˆ‡æ›¿
      recognition.interimResults = true;
      recognition.continuous = false;

      const textarea = document.getElementById("text");
      const micJaBtn = document.getElementById("micJaBtn");
      const micEnBtn = document.getElementById("micEnBtn");

      let finalText = "";

      // ãƒœã‚¿ãƒ³çŠ¶æ…‹
      micJaBtn.disabled = true;
      micEnBtn.disabled = true;

      const jaLabel = "ğŸ¤ æ—¥æœ¬èª";
      const enLabel = "ğŸ¤ English";

      if (lang === "ja-JP") micJaBtn.textContent = "ğŸ¤ æ—¥æœ¬èªï¼ˆèãå–ã‚Šä¸­â€¦ï¼‰";
      if (lang === "en-US") micEnBtn.textContent = "ğŸ¤ English (Listeningâ€¦)";

      recognition.onresult = (event) => {
        let interim = "";
        for (let i = event.resultIndex; i < event.results.length; i++) {
          const transcript = event.results[i][0].transcript;
          if (event.results[i].isFinal) {
            finalText += transcript;
          } else {
            interim += transcript;
          }
        }
        textarea.value = finalText + interim; // ä¸Šæ›¸ãï¼ˆè¿½è¨˜ã—ãŸã„ãªã‚‰è¨€ã£ã¦ãã ã•ã„ï¼‰
      };

      recognition.onerror = (event) => {
        alert("éŸ³å£°å…¥åŠ›ã‚¨ãƒ©ãƒ¼: " + event.error);
      };

      recognition.onend = () => {
        micJaBtn.disabled = false;
        micEnBtn.disabled = false;
        micJaBtn.textContent = jaLabel;
        micEnBtn.textContent = enLabel;
        textarea.focus();
      };

      recognition.start();
    }
  </script>
</body>
</html>


